#!/bin/bash

# Script: find_777_dynamic.sh
# Description: Dynamically finds all mounted partitions and scans them for world-writable files & dirs.
# Usage: sudo ./find_777_dynamic.sh

# Output file to save the results. Includes hostname and timestamp.
OUTPUT_FILE="/tmp/world_writable_scan_$(hostname)_$(date +%Y%m%d_%H%M%S).log"

# Header for the output
echo "=== DYNAMIC SCAN FOR WORLD-WRITABLE FILES & DIRECTORIES ===" | tee "$OUTPUT_FILE"
echo "Hostname: $(hostname)" | tee -a "$OUTPUT_FILE"
echo "Start Time: $(date)" | tee -a "$OUTPUT_FILE"
echo "================================================================" | tee -a "$OUTPUT_FILE"

# Get mounted partitions from /proc/mounts
echo "[INFO] Discovering mounted partitions from /proc/mounts..." | tee -a "$OUTPUT_FILE"
mapfile -t PARTITIONS < <(awk '$1 !~ /(tmpfs|proc|devtmpfs|sysfs|devpts|securityfs|pstore|cgroup|binfmt_misc|hugetlbfs|mqueue|debugfs|tracefs|fuse\.|overlay|sunrpc)/ {print $2}' /proc/mounts | sort -u)

echo "Found partitions to scan: ${PARTITIONS[*]}" | tee -a "$OUTPUT_FILE"
echo "================================================================" | tee -a "$OUTPUT_FILE"

# Loop through each dynamically found partition
for partition in "${PARTITIONS[@]}"; do
    if [[ -z "$partition" || "$partition" == "rootfs" ]]; then
        continue
    fi

    echo "[SCANNING: $partition]" | tee -a "$OUTPUT_FILE"

    echo "FILES:" | tee -a "$OUTPUT_FILE"
    find "$partition" -xdev -type f -perm -u=rwx,g=rwx,o=rwx -ls 2>/dev/null | tee -a "$OUTPUT_FILE"
    echo "" | tee -a "$OUTPUT_FILE"

    echo "DIRECTORIES:" | tee -a "$OUTPUT_FILE"
    find "$partition" -xdev -type d -perm -u=rwx,g=rwx,o=rwx -ls 2>/dev/null | tee -a "$OUTPUT_FILE"

    echo "================================================================" | tee -a "$OUTPUT_FILE"
done

echo "Scan completed. Detailed results saved to: $OUTPUT_FILE" | tee -a "$OUTPUT_FILE"
echo "End Time: $(date)" | tee -a "$OUTPUT_FILE"
